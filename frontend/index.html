<!DOCTYPE html>
<html lang="zh-CN" class="fonts-loading">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title></title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- 字体加载期间的过渡样式 -->
    <style>
      /* 字体加载中时隐藏不必要的重排 */
      .fonts-loading * {
        transition: none !important;
      }
      .fonts-loading body {
        visibility: hidden;
      }
      html:not(.fonts-loading) body {
        visibility: visible;
      }
    </style>

    <!-- 主题初始化脚本 - 防止白色闪烁，放在首个阻塞资源前 -->
    <script>
      (function () {
        const storageKey = "theme-preference";
        const getTheme = () => {
          if (localStorage.getItem(storageKey)) {
            return localStorage.getItem(storageKey);
          }
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        };
        // 立即应用主题（在页面渲染前添加 dark 类）
        if (getTheme() === "dark") {
          document.documentElement.classList.add("dark");
        }

        // 字体加载检测
        if ("fonts" in document) {
          document.fonts.ready.then(function () {
            document.documentElement.classList.remove("fonts-loading");
          });
        } else {
          // 降级：延迟移除加载类
          setTimeout(function () {
            document.documentElement.classList.remove("fonts-loading");
          }, 300);
        }

        // Font Loading Logic: Local with CDN Fallback using explicit content check
        async function loadFont(localPath, cdnPath) {
          try {
            const response = await fetch(localPath);
            const contentType = response.headers.get("content-type");
            // Check if request was successful AND content is actually CSS (not HTML fallback)
            if (
              response.ok &&
              contentType &&
              !contentType.includes("text/html")
            ) {
              const link = document.createElement("link");
              link.rel = "stylesheet";
              link.href = localPath;
              document.head.appendChild(link);
              return;
            } else {
              console.warn(
                `Local font invalid (HTML fallback detected) for: ${localPath}`
              );
            }
          } catch (e) {
            console.warn(`Local font check failed for ${localPath}:`, e);
          }

          // Fallback to CDN if local check failed or returned HTML
          console.log(`Falling back to CDN for ${localPath}`);
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = cdnPath;
          document.head.appendChild(link);
        }

        // Using IIFE async to allow await
        (async () => {
          await Promise.all([
            loadFont(
              "/fonts/ChillRoundFRegular/result.css",
              "https://fonts.suimori.com/ChillRoundFRegular/result.css"
            ),
            loadFont(
              "/fonts/ChillRoundFBold/result.css",
              "https://fonts.suimori.com/ChillRoundFBold/result.css"
            ),
          ]);
        })();
      })();
    </script>
    <style>
      body {
        font-family: "寒蝉全圆体", "Chill Round", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        font-weight: 400;
      }
    </style>
  </head>
  <body
    class="font-wenkai bg-light-100 text-text-primary transition-all duration-300 dark:bg-dark-300 dark:text-light-100 min-h-screen flex flex-col"
  >
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
