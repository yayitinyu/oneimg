import{r as l,o as z,c as p,d as f,f as e,i as y,t as v,g as b,v as x,e as S,s as V,n as h,M as a,z as D}from"./index-B4jSO19r.js";const L={class:"text-gray-800 dark:text-gray-200"},N={class:"container mx-auto px-4 pb-16"},Q={class:"grid grid-cols-1 md:grid-cols-2 gap-8"},$={class:"bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full"},O={class:"panel-content p-6 md:p-8"},q={class:"flex items-center gap-4 mb-6"},E={class:"relative"},F={class:"w-20 h-20 rounded-full bg-gradient-to-br from-primary to-blue-400 flex items-center justify-center text-white font-bold overflow-hidden"},J=["src"],R={key:1,class:"text-2xl"},W={class:"font-medium text-gray-900 dark:text-white"},G={class:"setting-group mb-6"},H=["disabled"],K={key:0,class:"ri-loader-4-line animate-spin"},X={class:"setting-group"},Y={class:"setting-group"},Z={class:"setting-group"},ee={class:"setting-group"},te={class:"setting-group pt-2"},re=["disabled"],se={key:0,class:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"},ae={class:"bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full"},oe={class:"panel-content p-6 md:p-8"},ne={class:"space-y-6"},ie={class:"flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700"},le={class:"text-gray-900 dark:text-white font-semibold"},de={class:"flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700"},ue={class:"flex items-center gap-3"},me={__name:"Account",setup(ce){const U=D(),o=l({newUsername:"",currentPassword:"",newPassword:"",confirmPassword:""}),n=l({username:"",nickname:"",avatar:""}),d=l({nickname:""}),P=l(null),w=l(!1),u=l({type:"loading",connected:!1}),k=l(!1),T=async()=>{try{const r=await fetch("/api/user/profile",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(r.ok){const t=await r.json();t.code===200&&t.data&&(n.value=t.data,d.value.nickname=t.data.nickname||"")}}catch(r){console.error("获取用户资料失败:",r)}},j=async()=>{if(!d.value.nickname.trim()){a.warning("请输入昵称");return}w.value=!0;try{const r=await fetch("/api/user/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({nickname:d.value.nickname})}),t=await r.json();if(r.ok&&t.code===200)n.value.nickname=d.value.nickname,a.success("昵称更新成功");else throw new Error(t.message||"更新失败")}catch(r){a.error(r.message||"更新失败")}finally{w.value=!1}},A=()=>{P.value?.click()},C=async r=>{const t=r.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){a.error("请选择图片文件");return}const s=new FormData;s.append("images[]",t);try{const c=await fetch("/api/upload/images?hidden=true",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:s}),i=await c.json();if(c.ok&&i.code===200&&i.data?.files?.length>0){const m=i.data.files[0].url;(await fetch("/api/user/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({avatar:m})})).ok&&(n.value.avatar=m,a.success("头像更新成功"))}else throw new Error(i.message||"上传失败")}catch(c){a.error("头像上传失败: "+c.message)}r.target.value=""},B=r=>({postgresql:"PostgreSQL",mysql:"MySQL",sqlite:"SQLite",loading:"加载中..."})[r]||r,I=async()=>{try{const r=await fetch("/api/database/status",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(r.ok){const t=await r.json();t.code===200&&t.data&&(u.value=t.data)}}catch(r){console.error("获取数据库状态失败:",r)}},M=async()=>{const{newUsername:r,currentPassword:t,newPassword:s,confirmPassword:c}=o.value,i=r&&r.trim()!=="",m=s&&s.trim()!=="";if(!i&&!m){a.error("请输入要修改的用户名或密码");return}if(i){if(r.length<3){a.error("用户名长度至少为3位");return}if(r.length>20){a.error("用户名长度不能超过20位");return}}if(m){if(s.length<6){a.error("新密码长度至少为6位");return}if(s!==c){a.error("两次输入的新密码不一致");return}}if(!t){a.error("请输入当前密码以确认修改");return}try{k.value=!0;const g=await fetch("/api/account/change",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({new_username:r,current_password:t,new_password:s})}),_=await g.json();if(!g.ok||!_.success){if(g.status===401)return localStorage.removeItem("authToken"),U.push("/login"),a.error("登录已过期，请重新登录");throw new Error(_.message||"修改失败")}a.success("修改成功"),o.value={newUsername:"",currentPassword:"",newPassword:"",confirmPassword:""},setTimeout(()=>{window.location.reload()},1e3)}catch(g){a.error(g.message||"更新失败")}finally{k.value=!1}};return z(()=>{I(),T()}),(r,t)=>(f(),p("div",L,[t[21]||(t[21]=e("div",{class:"settings-header container mx-auto px-4 py-4"},[e("h1",{class:"page-title flex items-center text-2xl md:text-3xl font-bold"}," 设置 "),e("p",{class:"page-description text-gray-600 dark:text-gray-400 mt-2"},"管理您的系统账户")],-1)),e("div",N,[e("div",Q,[e("div",$,[e("div",O,[t[14]||(t[14]=e("h2",{class:"panel-title flex items-center text-xl font-semibold mb-6"},[e("span",{class:"panel-icon mr-2 text-2xl"},[e("i",{class:"ri-user-3-line"})]),y(" 个人资料 ")],-1)),e("div",q,[e("div",E,[e("div",F,[n.value.avatar?(f(),p("img",{key:0,src:n.value.avatar,class:"w-full h-full object-cover",alt:"头像"},null,8,J)):(f(),p("span",R,v((n.value.nickname||n.value.username||"U").charAt(0).toUpperCase()),1))]),e("button",{type:"button",onClick:A,class:"absolute -bottom-1 -right-1 w-7 h-7 bg-primary hover:bg-primary-dark text-white rounded-full flex items-center justify-center shadow-md transition-colors",title:"更换头像"},[...t[5]||(t[5]=[e("i",{class:"ri-camera-line text-sm"},null,-1)])]),e("input",{ref_key:"avatarInput",ref:P,type:"file",accept:"image/*",onChange:C,class:"hidden"},null,544)]),e("div",null,[e("p",W,v(n.value.nickname||n.value.username||"未设置"),1),t[6]||(t[6]=e("p",{class:"text-sm text-gray-500 dark:text-gray-400"},"点击更换头像",-1))])]),e("div",G,[t[8]||(t[8]=e("label",{class:"setting-label block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",for:"nickname"}," 昵称 ",-1)),b(e("input",{id:"nickname","onUpdate:modelValue":t[0]||(t[0]=s=>d.value.nickname=s),type:"text",class:"setting-input w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-primary dark:focus:ring-primary/70 dark:focus:border-primary/70 transition-colors outline-none",placeholder:"设置您的昵称",maxlength:"20"},null,512),[[x,d.value.nickname]]),e("button",{type:"button",onClick:j,disabled:w.value,class:"mt-3 w-full py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2"},[w.value?(f(),p("i",K)):S("",!0),t[7]||(t[7]=e("span",null,"保存昵称",-1))],8,H)]),t[15]||(t[15]=e("hr",{class:"border-gray-200 dark:border-gray-700 my-6"},null,-1)),t[16]||(t[16]=e("h3",{class:"flex items-center text-lg font-semibold mb-4"},[e("span",{class:"mr-2 text-xl"},[e("i",{class:"ri-shield-user-line"})]),y(" 安全设置 ")],-1)),e("form",{onSubmit:V(M,["prevent"]),class:"account-form space-y-6"},[e("div",X,[t[9]||(t[9]=e("label",{class:"setting-label block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",for:"newUsername"}," 新用户名（留空则不修改） ",-1)),b(e("input",{id:"newUsername","onUpdate:modelValue":t[1]||(t[1]=s=>o.value.newUsername=s),type:"text",class:"setting-input w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-primary dark:focus:ring-primary/70 dark:focus:border-primary/70 transition-colors outline-none",placeholder:"留空则不修改用户名",minlength:"3",maxlength:"20"},null,512),[[x,o.value.newUsername]])]),e("div",Y,[t[10]||(t[10]=e("label",{class:"setting-label block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",for:"currentPassword"},[y(" 当前密码 "),e("span",{class:"text-red-500"},"*")],-1)),b(e("input",{id:"currentPassword","onUpdate:modelValue":t[2]||(t[2]=s=>o.value.currentPassword=s),type:"password",class:"setting-input w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-primary dark:focus:ring-primary/70 dark:focus:border-primary/70 transition-colors outline-none",placeholder:"请输入当前密码以确认修改",required:""},null,512),[[x,o.value.currentPassword]])]),e("div",Z,[t[11]||(t[11]=e("label",{class:"setting-label block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",for:"newPassword"}," 新密码（留空则不修改） ",-1)),b(e("input",{id:"newPassword","onUpdate:modelValue":t[3]||(t[3]=s=>o.value.newPassword=s),type:"password",class:"setting-input w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-primary dark:focus:ring-primary/70 dark:focus:border-primary/70 transition-colors outline-none",placeholder:"留空则不修改密码（至少6位）",minlength:"6"},null,512),[[x,o.value.newPassword]])]),e("div",ee,[t[12]||(t[12]=e("label",{class:"setting-label block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",for:"confirmPassword"}," 确认新密码 ",-1)),b(e("input",{id:"confirmPassword","onUpdate:modelValue":t[4]||(t[4]=s=>o.value.confirmPassword=s),type:"password",class:"setting-input w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-primary dark:focus:ring-primary/70 dark:focus:border-primary/70 transition-colors outline-none",placeholder:"请再次输入新密码"},null,512),[[x,o.value.confirmPassword]])]),e("div",te,[e("button",{type:"submit",disabled:k.value,class:"setting-btn accent w-full py-3 px-6 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2 focus:ring-2 focus:ring-primary/50 focus:outline-none"},[k.value?(f(),p("span",se)):S("",!0),t[13]||(t[13]=e("span",null,"保存修改",-1))],8,re)])],32)])]),e("div",ae,[e("div",oe,[t[20]||(t[20]=e("h2",{class:"panel-title flex items-center text-xl font-semibold mb-8"},[e("span",{class:"panel-icon mr-2 text-2xl"},[e("i",{class:"ri-database-2-line"})]),y(" 数据库状态 ")],-1)),e("div",ne,[e("div",ie,[t[17]||(t[17]=e("div",{class:"flex items-center gap-3"},[e("div",{class:"w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center"},[e("i",{class:"ri-stack-line text-blue-600 dark:text-blue-400 text-xl"})]),e("span",{class:"text-gray-700 dark:text-gray-300 font-medium"},"数据库类型")],-1)),e("span",le,v(B(u.value.type)),1)]),e("div",de,[e("div",ue,[e("div",{class:h(["w-10 h-10 rounded-lg flex items-center justify-center",u.value.connected?"bg-green-100 dark:bg-green-900/30":"bg-red-100 dark:bg-red-900/30"])},[e("i",{class:h(["text-xl",u.value.connected?"ri-checkbox-circle-line text-green-600 dark:text-green-400":"ri-close-circle-line text-red-600 dark:text-red-400"])},null,2)],2),t[18]||(t[18]=e("span",{class:"text-gray-700 dark:text-gray-300 font-medium"},"连接状态",-1))]),e("span",{class:h(["px-3 py-1 rounded-full text-sm font-medium",u.value.connected?"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400":"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400"])},v(u.value.connected?"已连接":"未连接"),3)]),t[19]||(t[19]=e("div",{class:"mt-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg"},[e("p",{class:"text-sm text-gray-600 dark:text-gray-400"},[e("i",{class:"ri-information-line mr-1"}),y(" 数据库配置通过环境变量设置，修改后需重启服务生效。 ")]),e("p",{class:"text-xs text-gray-500 dark:text-gray-500 mt-2"}," 优先级：PostgreSQL > MySQL > SQLite ")],-1))])])])])])]))}};export{me as default};
