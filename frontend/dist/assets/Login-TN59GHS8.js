import{r as u,a as V,w as B,o as E,b as N,c as y,d as v,e as x,f as r,t as U,g as C,v as R,h as M,n as _,i as z,M as c}from"./index-DQrT0z4C.js";const I={class:"login flex items-center justify-center p-4"},q={key:0,class:"fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50"},D={class:"loading-card bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-md w-full m-[15px] flex flex-col items-center justify-center"},G={class:"loading-title text-lg font-bold text-center text-gray-800 dark:text-white mb-2"},H={class:"loading-text text-center text-gray-600 dark:text-gray-300 mb-4"},J={class:"card-body p-6"},A={class:"form-group mb-6"},W=["disabled"],Q={class:"form-group mb-6"},X=["disabled"],Y={key:0,class:"form-group mb-6"},Z={class:"form-group"},$=["disabled"],ee={key:1,class:"form-group mt-4"},te=["disabled"],ae={__name:"Login",setup(re){const d=u(""),g=u(""),s=u(!1),b=u(""),w=u(""),T=u(0),i=u("");let m=null;const a=V({turnstile:!1,turnstileSiteKey:"",tourist:!1}),f=(t,e,n=0)=>{s.value=!0,b.value=t,w.value=e,T.value=n},k=()=>{s.value=!1,b.value="",w.value="",T.value=0},O=async()=>{try{return(await window.GuestFingerprint.getRequestParams()).guest_uuid}catch(t){return console.error("生成游客指纹失败:",t),"guest_"+Math.random().toString(36).substr(2,16)}},P=async()=>{if(s.value)return;if(a.turnstile&&!i.value){c.warning("请完成人机验证");return}f("游客登录","正在生成游客身份...",30);const t=await O();d.value=t,g.value="tourist_"+t.substr(0,8),f("游客登录","正在登录...",60),L(i.value,t)},h=()=>{if(!s.value){if(!d.value||!g.value){c.warning("请输入用户名和密码");return}if(a.turnstile&&!i.value){c.warning("请完成人机验证");return}L(i.value)}},L=async(t,e="")=>{f("登录中","正在验证用户信息...",90);try{const n={username:d.value,password:g.value,turnstileToken:t};if(e){n.touristFingerprint=e;try{const o=await window.GuestFingerprint.getRequestParams();n.fusionHash=o.fusion_hash,n.stableFeatures=o.stable_features}catch(o){console.error("获取指纹参数失败:",o)}}const S=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),l=await S.json();if(S.ok&&l.code===200){l.data&&l.data.token&&localStorage.setItem("authToken",l.data.token);const o=l.data&&l.data.user||{},K={username:o.username||d.value,nickname:o.nickname||"",avatar:o.avatar||"",role:o.role,isTourist:!!e,touristFingerprint:e||""};localStorage.setItem("userInfo",JSON.stringify(K)),f(l.message||"登录成功","即将跳转到主页...",100),setTimeout(()=>{k(),window.location.href="/"},1500)}else k(),c.error("登录失败: "+(l.message||"未知错误")),j()}catch(n){k(),c.error("登录请求失败，请检查网络连接: "+n.message),j()}},p=()=>{if(!a.turnstile)return;const t=document.getElementById("turnstile-container");if(!t||!window.turnstile){setTimeout(p,500);return}t.innerHTML="",m=window.turnstile.render("#turnstile-container",{sitekey:a.turnstileSiteKey,callback:e=>{i.value=e},"expired-callback":()=>{i.value=""},"error-callback":()=>{c.error("验证组件加载失败"),i.value=""},theme:document.documentElement.classList.contains("dark")?"dark":"light"})},j=()=>{m&&window.turnstile&&(window.turnstile.reset(m),i.value="")},F=async()=>{try{const t=await fetch("/api/settings/login",{method:"GET",headers:{"Content-Type":"application/json"}}),e=await t.json();t.ok&&e.code===200?(a.turnstile=e.data.turnstile||!1,a.turnstileSiteKey=e.data.turnstile_site_key||"",a.tourist=e.data.tourist||!1):console.error("获取登录配置失败")}catch(t){console.error("获取登录配置失败:",t)}};return B(()=>a.turnstile,t=>{t&&setTimeout(p,100)}),E(async()=>{if(!URL.revokeObjectUrl&&URL.revokeObjectURL&&(URL.revokeObjectUrl=URL.revokeObjectURL),await F(),document.querySelector('script[src*="turnstile"]'))a.turnstile&&p();else{const t=document.createElement("script");t.src="https://challenges.cloudflare.com/turnstile/v0/api.js",t.async=!0,t.defer=!0,t.onload=()=>{console.log("Turnstile 脚本加载完成"),a.turnstile&&p()},t.onerror=()=>{console.error("Turnstile 脚本加载失败")},document.head.appendChild(t)}}),N(()=>{m&&window.turnstile&&window.turnstile.remove(m)}),(t,e)=>(v(),y("div",I,[s.value?(v(),y("div",q,[r("div",D,[e[2]||(e[2]=r("div",{class:"loading-spinner mb-4"},[r("svg",{class:"animate-spin h-10 w-10 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[r("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),r("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})])],-1)),r("h3",G,U(b.value),1),r("p",H,U(w.value),1)])])):x("",!0),r("div",{class:_(["card bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md transition-all duration-300",{"opacity-50 pointer-events-none":s.value}])},[r("div",J,[e[7]||(e[7]=r("h5",{class:"card-title text-2xl font-bold text-center text-gray-800 dark:text-white mb-8"},"登录",-1)),r("div",A,[e[3]||(e[3]=r("label",{for:"username",class:"form-label block text-gray-700 dark:text-gray-300 mb-2"},"用户名",-1)),C(r("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>d.value=n),class:"form-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white transition-all outline-none",placeholder:"用户名",disabled:s.value,onKeyup:M(h,["enter"])},null,40,W),[[R,d.value]])]),r("div",Q,[e[4]||(e[4]=r("label",{for:"password",class:"form-label block text-gray-700 dark:text-gray-300 mb-2"},"密码",-1)),C(r("input",{type:"password","onUpdate:modelValue":e[1]||(e[1]=n=>g.value=n),class:"form-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white transition-all outline-none",placeholder:"密码",disabled:s.value,onKeyup:M(h,["enter"])},null,40,X),[[R,g.value]])]),a.turnstile?(v(),y("div",Y,[...e[5]||(e[5]=[r("div",{class:"flex justify-center transform scale-90 sm:scale-100 origin-center"},[r("div",{id:"turnstile-container"})],-1)])])):x("",!0),r("div",Z,[r("button",{onClick:h,class:_(["login-btn w-full py-3 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center",{"opacity-70 cursor-not-allowed":s.value}]),disabled:s.value}," 登录 ",10,$)]),a.tourist?(v(),y("div",ee,[r("button",{onClick:P,class:_(["tourist-login-btn w-full py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-lg transition-all duration-200 flex items-center justify-center gap-2",{"opacity-70 cursor-not-allowed":s.value}]),disabled:s.value},[...e[6]||(e[6]=[r("i",{class:"ri-user-line"},null,-1),z(" 游客访问 ",-1)])],10,te)])):x("",!0)])],2)]))}};export{ae as default};
